<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Experience Questionnaire - In-Game</title>
    <link rel="stylesheet" href="geq-styles.css">
    <script src="geq-common.js"></script>
</head>
<body>
<div class="navigation-links">
    <a href="index.html">Questionario End-Session</a> |
    <span class="current-page">Questionario In-Game</span>
</div>
<div class="container">
    <h1>Game Experience Questionnaire</h1>
    <h2>In-Game Module</h2>

    <div id="start-section" class="player-info">
        <p>Questo questionario raccoglie la tua esperienza <strong>durante</strong> la sessione di gioco.</p>
        <p>Il tuo identificativo univoco è:</p>
        <div id="player-id" class="player-id">Generazione ID...</div>
        <div style="margin-top: 20px;">
            <button id="start-button" onclick="startQuestionnaire()">Inizia Questionario</button>
        </div>
    </div>

    <div id="questionnaire" style="display: none;">
        <div class="instructions">
            <p>Per favore indica come ti sei sentito <strong>durante</strong> l'esperienza di gioco per ciascuna delle affermazioni sotto.</p>
            <p>Le opzioni disponibili sono: <strong>Per niente (0), Leggermente (1), Moderatamente (2), Abbastanza (3), Estremamente (4)</strong></p>
        </div>

        <div class="progress-bar">
            <div id="progress" class="progress"></div>
        </div>

        <div id="questions-container"></div>

        <div class="incomplete-questions" id="incomplete-warning">
            Ci sono domande senza risposta. Per completare il questionario, bisogna rispondere a tutte le domande.
        </div>

        <div class="submit-container">
            <button id="submit-button" onclick="completeQuestionnaire()">Completa Questionario</button>
        </div>
    </div>

    <div id="thank-you" class="thank-you">
        <h2>Grazie per aver completato il questionario!</h2>
        <p>I tuoi dati sono stati salvati con successo.</p>
        <p>Il tuo ID partecipante è: <span id="final-player-id" class="player-id"></span></p>

        <div class="download-buttons">
            <p>Puoi anche salvare una copia locale dei tuoi risultati:</p>
            <button onclick="downloadQuestionnaireDataAsJson()">Scarica come JSON</button>
            <button onclick="downloadQuestionnaireDataAsCsv()">Scarica come CSV</button>
        </div>

        <div class="navigation-links" style="margin-top: 20px;">
            <a href="index.html">Vai al Questionario End-Session</a> |
            <a href="ingame.html">Nuovo Questionario In-Game</a>
        </div>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Invio dei dati in corso...</p>
    </div>

    <div id="error-section" class="error-section" style="display: none;">
        <h2>Errore di connessione</h2>
        <p>Si è verificato un errore durante l'invio dei dati al server.</p>
        <p>Puoi scaricare una copia locale dei tuoi dati:</p>

        <div class="download-buttons">
            <button onclick="downloadQuestionnaireDataAsJson()">Scarica come JSON</button>
            <button onclick="downloadQuestionnaireDataAsCsv()">Scarica come CSV</button>
        </div>

        <p>Il tuo ID partecipante è: <span id="error-player-id" class="player-id"></span></p>

        <button onclick="retrySubmission()" class="retry-button">Riprova invio</button>
    </div>
</div>

<script>
    const questionnaire = {
        title: "Game Experience Questionnaire",
        module: {
            name: "In-game Module",
            description: "Presenza/Immersione",
            questions: [
                { id: 34, text: "Mi interessava la storia del gioco" },
                { id: 35, text: "Mi sono sentito/a soddisfatto/a" },
                { id: 36, text: "Mi sono annoiato/a" },
                { id: 37, text: "L'ho trovato impressionante" },
                { id: 38, text: "Ho dimenticato tutto ciò che mi circondava" },
                { id: 39, text: "Mi sono sentito/a frustrato/a" },
                { id: 40, text: "L'ho trovato stancante" },
                { id: 41, text: "Mi sono sentito/a irritabile" },
                { id: 42, text: "Mi sono sentito/a abile" },
                { id: 43, text: "Mi sono sentito completamente assorbito/a" },
                { id: 44, text: "Mi sono sentito/a contento/a" },
                { id: 45, text: "Mi sono sentito/a sfidato/a" },
                { id: 46, text: "Ho dovuto metterci molto impegno" },
                { id: 47, text: "Mi sono sentito/a bene" }
            ]
        },
        responseOptions: [
            { value: 0, text: "Per niente" },
            { value: 1, text: "Leggermente" },
            { value: 2, text: "Moderatamente" },
            { value: 3, text: "Abbastanza" },
            { value: 4, text: "Estremamente" }
        ]
    };

    // Variabili globali
    let responses = {};
    let playerInfo = {};

    // Inizializzazione del questionario
    function initQuestionnaire() {
        // Genera un ID univoco per il giocatore
        const playerId = generateUniqueId();
        document.getElementById('player-id').textContent = playerId;

        // Inizializza risposte e info giocatore
        responses = {};
        playerInfo = {
            id: playerId,
            timestamp: new Date().toISOString(),
            type: "in_game"
        };

        // Inizializza le risposte per il modulo
        responses[questionnaire.module.name] = {};
    }

    // Crea la UI del questionario
    function createQuestionnaireUI() {
        const questionsContainer = document.getElementById('questions-container');

        // Pulisci il contenitore
        questionsContainer.innerHTML = '';

        // Crea le domande
        questionnaire.module.questions.forEach(question => {
            // Contenitore della domanda
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question';

            // Testo della domanda
            const questionText = document.createElement('div');
            questionText.className = 'question-text';
            questionText.innerText = question.text;
            questionDiv.appendChild(questionText);

            // Opzioni di risposta
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options';

            // Crea ciascuna opzione
            questionnaire.responseOptions.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = `question-${question.id}`;
                radio.value = option.value;
                radio.id = `q${question.id}-o${option.value}`;
                radio.onchange = () => saveResponse(questionnaire.module.name, question.id, option.value);

                const label = document.createElement('label');
                label.htmlFor = `q${question.id}-o${option.value}`;
                label.innerText = option.text;

                optionDiv.appendChild(radio);
                optionDiv.appendChild(label);
                optionsDiv.appendChild(optionDiv);
            });

            questionDiv.appendChild(optionsDiv);
            questionsContainer.appendChild(questionDiv);
        });

        updateProgressBar();
    }

    // Salva una risposta
    function saveResponse(moduleName, questionId, value) {
        responses[moduleName][questionId] = parseInt(value);
        updateProgressBar();
        checkCompletion();
    }

    // Controlla se tutte le domande hanno risposta
    function checkCompletion() {
        const allAnswered = isModuleComplete(questionnaire.module.name, questionnaire.module.questions, responses);

        const incompleteWarning = document.getElementById('incomplete-warning');
        incompleteWarning.style.display = allAnswered ? 'none' : 'block';

        // Abilita/disabilita il pulsante di completamento
        const submitButton = document.getElementById('submit-button');
        submitButton.disabled = !allAnswered;
    }

    // Aggiorna la barra di progresso
    function updateProgressBar() {
        const status = checkAllQuestionsAnswered(responses, questionnaire.module);

        // Calcola la percentuale
        const percentage = (status.answered / status.total) * 100;

        // Aggiorna la barra di progresso
        const progressBar = document.getElementById('progress');
        progressBar.style.width = `${percentage}%`;
    }

    // Inizia il questionario
    function startQuestionnaire() {
        // Nascondi la sezione iniziale e mostra il questionario
        document.getElementById('start-section').style.display = 'none';
        document.getElementById('questionnaire').style.display = 'block';

        // Crea la UI del questionario
        createQuestionnaireUI();
    }

    // Completa il questionario
    function completeQuestionnaire() {
        // Verifica che tutte le domande abbiano ricevuto risposta
        const status = checkAllQuestionsAnswered(responses, questionnaire.module);

        if (!status.isComplete) {
            alert(`Per completare il questionario è necessario rispondere a tutte le domande. Mancano ancora ${status.total - status.answered} risposte.`);
            return;
        }

        // Mostra il loading spinner
        document.getElementById('questionnaire').style.display = 'none';
        document.getElementById('loading').style.display = 'block';

        // Invia i dati a Google Sheets
        sendDataToGoogleSheets(
            playerInfo,
            responses,
            questionnaire.module,
            function onSuccess(data) {
                // Nascondi il loading e mostra il messaggio di completamento
                document.getElementById('loading').style.display = 'none';
                document.getElementById('thank-you').style.display = 'block';
                document.getElementById('final-player-id').textContent = playerInfo.id;
            },
            function onError(error) {
                // Nascondi il loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-section').style.display = 'block';
                document.getElementById('error-player-id').textContent = playerInfo.id;

                console.error('Errore:', error);
            }
        );
    }

    // Funzioni di download
    function downloadQuestionnaireDataAsJson() {
        // Prepara i dati completi
        const data = {
            playerInfo: playerInfo,
            responses: responses,
            module: questionnaire.module
        };

        // Usa la funzione comune per il download
        downloadAsJson(data, `geq_in_game_${playerInfo.id}`);
    }

    function downloadQuestionnaireDataAsCsv() {
        // Prepara i dati completi
        const data = {
            playerInfo: playerInfo,
            responses: responses,
            module: questionnaire.module
        };

        // Usa la funzione comune per il download
        downloadAsCsv(data, `geq_in_game_${playerInfo.id}`);
    }

    // Funzione per riprovare l'invio
    function retrySubmission() {
        // Nascondi la sezione di errore
        document.getElementById('error-section').style.display = 'none';

        // Mostra nuovamente il loading
        document.getElementById('loading').style.display = 'block';

        // Riprova a inviare i dati
        sendDataToGoogleSheets(
            playerInfo,
            responses,
            questionnaire.module,
            function onSuccess(data) {
                // Nascondi il loading e mostra il messaggio di completamento
                document.getElementById('loading').style.display = 'none';
                document.getElementById('thank-you').style.display = 'block';
                document.getElementById('final-player-id').textContent = playerInfo.id;
            },
            function onError(error) {
                // Nascondi il loading
                document.getElementById('loading').style.display = 'none';

                // Mostra la sezione di errore
                document.getElementById('error-section').style.display = 'block';
                document.getElementById('error-player-id').textContent = playerInfo.id;

                console.error('Errore:', error);
            }
        );
    }

    // Inizializza il questionario quando la pagina è caricata
    window.onload = initQuestionnaire;
</script>
</body>
</html>